services:
  clients:
    build:
      context: ./
      dockerfile: ./clients/Dockerfile
    ports:
      - "5173:5173"
    volumes:
      - ./clients:/app/clients
      - /app/clients/node_modules # So HMR works
    command: npm run dev
    # depends_on:
    #   - services__auth

  services__auth:
    build:
      context: ./
      dockerfile: ./services/auth/Dockerfile
    ports:
      - "3000:3000"
    # need to fix db container; right now changes to db are triggering sync+restart
    volumes:
      - ./dbs/auth/data:/app/dbs/auth/data
    environment:
      - SQLITE_DB_PATH=/app/data/database.sqlite
      - PORT=3000
      - NODE_ENV=development
    command: npm start
    develop:
      watch:
        - action: sync+restart
          path: ./services/auth
          target: /app/services/auth
          ignore:
            - ./services/auth/node_modules/

        # ../db
        - action: sync+restart
          path: ./dbs/auth/src
          target: /app/dbs/auth/src

        # ../specs/apis
        - action: sync+restart
          path: ./specs/apis/dist
          target: /app/specs/apis/dist

  services__api:
    build:
      context: ./
      dockerfile: ./services/api/Dockerfile
    ports:
      - "3002:3002"
    # volumes:
    #   - ./dbs/main/data:/app/dbs/main/data
    environment:
      - PORT=3002
      - NODE_ENV=development
      - CORS_ORIGIN=http://localhost:5173
    command: npm start
    develop:
      watch:
        - action: sync+restart
          path: ./services/api
          target: /app/services/api
          ignore:
            - ./services/api/node_modules/

        # ../db
        - action: sync+restart
          path: ./dbs/main/src
          target: /app/dbs/main/src
          ignore:
            - ./dbs/main/node_modules/

        # ../specs/apis
        - action: sync+restart
          path: ./specs/apis/dist
          target: /app/specs/apis/dist

  specs__apis:
    build:
      context: ./
      dockerfile: ./specs/apis/Dockerfile
    ports:
      - "3001:3001"
    volumes:
      - ./specs/apis/dist:/app/specs/apis/dist
    develop:
      watch:
        - action: sync+restart
          path: ./specs/apis/openapi.yaml
          target: /app/specs/apis/openapi.yaml
    command: npm run generate-and-serve